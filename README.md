# Conditional Graph VAE for Ni YSZ anodes of SOFC
В рамках данного проекта проводится анализ трехфазной стуктуры анодного слоя (Ni-YSZ) твердооксидного топливного элемента (ТОТЭ, SOFC).

Исходными данными для формирования датасета является данные работы "FIB-tomography data of Ni-YSZ anodes for Solid Oxide Fuel Cells (SOFC): Comparison of pristine and degraded materials (before/after redox cycling)" (Holzer, L., Pecho, O., Hocker, T., Iwanschitz, B., & Mai, A. (2020). FIB-tomography data of Ni-YSZ anodes for Solid Oxide Fuel Cells (SOFC): Comparison of pristine and degraded materials (before/after redox cycling) (Версия 1) [Data set]. Zenodo. https://doi.org/10.5281/zenodo.4056538)

# Описание исследуемых материалов
### 1. Общее назначение и внешний вид
Ni-YSZ — это пористая, механически прочная, электропроводящая губка, которая служит:
- местом протекания реакции: окисления водорода (или углеводородов).
- электронным проводником: от места реакции к токосъемнику.
- путем для подачи топлива: газы свободно диффундируют сквозь поры.
- подложкой/носителем: для тонкого электролита (часто YSZ), который наносят поверх него.

В сечении ТОТЭ (электролит-поддерживающая конструкция) это самый толстый слой (от 300 до 1000 мкм). Он выглядит как мелкозернистая, матовая, серо-черная пластина. После восстановления NiO до Ni он приобретает металлический блеск в изломе.

### 2. Трехфазная структура
Электрохимическая реакция `(H₂ + O²⁻ → H₂O + 2e⁻)` эффективно протекает только в местах, где одновременно присутствуют:
- `Ni` — катализатор диссоциации `H₂` и проводник электронов.
- `YSZ` — проводник ионов кислорода `O²⁻`.
- `Пора` — канал для подвода газообразного `H₂` и отвода паров `H₂O`.

Таким образом, трехфазная структура — это взаимопроникающая сеть этих трех компонентов. Трехфазная структура характеризуется признаком - длина трехфазных границ (ТФГ).

### 3. Эволюция структуры во время работы (деградация)
Структура анода не статична, что является основной проблемой:
- **коалесценция** (укрупнение) частиц `Ni`: высокая температура и наличие пара воды приводят к "спеканию" наночастиц `Ni` в более крупные капли. Это разрывает `Ni`-сеть, увеличивает сопротивление, сокращает длину `ТФГ`. На СЭМ это выглядит как увеличение среднего размера частиц `Ni` и их изолированность.
- **отравление**: примеси (например, сера) блокируют активные центры на поверхности `Ni`.
- **окисление-восстановление**: циклы окисления (если поступает кислород) и восстановления `Ni` вызывают повторные изменения объема, разрушающие тонкую структуру `YSZ-каркаса`.
- **разрушение** cтруктуры `YSZ` при изменении объема `NiO`

<img height="400" alt="Без названия (4)" src="https://github.com/user-attachments/assets/2f71552f-9f9f-4e3b-8ef9-72ee3d089f1b" />


# Описание исходных данных:
Набор данных содержит трехмерные стеки изображений, полученные с помощью ионно-лучевой томографии (FIB-томографии) с анодов из никель-иттрий-сульфидного диоксида циркония (Ni-YSZ) для твердооксидных топливных элементов (SOFC).

Данные были собраны с трех различных анодов из Ni-YSZ (мелкозернистых, среднезернистых и крупнозернистых). Каждый из этих анодов исследовался сначала в исходном состоянии (после спекания и восстановления), а затем также в деградированном состоянии (после воздействия 8 окислительно-восстановительных циклов).

Затем 6 томограмм представлены в виде стопок 2D-изображений в формате TIFF в двух разных версиях: в виде изображений в оттенках серого (исходные данные) и в виде сегментированных изображений (Ni = белый, YSZ = серый и поры = черный).

### Срезы образцов
<table width=100%>
  <tr>
    <th>-</th>
    <th>Мелкозернистые (fine)</th>
    <th>Среднезернистые (medium)</th>
    <th>Крупнозернистые (coarse)</th>
  </tr>
  <tr>
    <td width="150">Исходное состояние (pristine)</td>
    <td><img width="200"  alt="pristine_fine" src="https://github.com/user-attachments/assets/d429f9fa-0a94-469e-b1a7-55eb1b2b399e" /></td>
    <td><img width="200" alt="pristine_medium" src="https://github.com/user-attachments/assets/91e15ab6-0b13-484f-877d-5fa88943f711" /></td>
    <td><img width="200"  alt="prisitne_coarse" src="https://github.com/user-attachments/assets/7f9cd6a0-4af8-4c64-9b61-38fc94208eb2" /></td>
  </tr>
  <tr>
    <td width="150">Деградация после 8 редокс-циклов (degraded)</td>
    <td><img width="200" alt="degraded_fine" src="https://github.com/user-attachments/assets/64e22a2b-da6f-4f60-a6e7-9cbc1a86d237" /></td>
    <td><img width="200"  alt="degraded_medium" src="https://github.com/user-attachments/assets/96444005-f968-41a9-86d6-74350fc24864" /></td>
    <td><img width="200"  alt="degraded_coarse" src="https://github.com/user-attachments/assets/6a2e0cbe-2488-4a19-90bb-8a96ee1b298c" /></td>
  </tr>
</table>

### Общий вид стака изображений ###
<img width="400"  alt="6Segment_01" src="https://github.com/user-attachments/assets/21bc7c09-c1ff-4404-90ed-e4339c4405e0" />

Размеры стаков:
<ul>
  <li><b>pristine_fine</b>    (995x1304x733 вокселей),  </li>
  <li><b>pristine_medium</b>  (960x1110x610 вокселей)</li>
  <li><b>pristine_coarse</b>  (744x1417x<b>456</b> вокселей)</li>
  <li><b>degraded_fine</b>    (1171x1343x461 вокселей)</li>
  <li><b>degraded_medium</b>  (1318x1520x459 вокселей)</li>
  <li><b>degraded_coarse</b>  (1368x1630x500 вокселей)</li> 
</ul>

Обработка массива размером 995x1304x733 значений - 951 млн.параметров требует огромных вычислительных мощностей, поэтому каждый стек будет разделен на патчи (кубики) размерами 456х456х456.
Размерность 456 взята как минимальная сторона у стака **pristine_coarse**.
Также разделение стака на патчи увеличивает численное количество уникальных образцов для обучающей выборки.

# Цели и задачи:
- сравнить эффективность различных ML моделей выявлять скрытые признаки и различия между структурами `Ni-YSZ` до и после деградации (8 редокс-циклов)
- построить ML-модель, способную прогнозировать изменение структуры в промежуточных значениях от 0 до 8 цикла
- определить структуры наиболее устойчивые к деградации (наиболее удаленные структуры от зоны `degraded`)
  
# 1. Загрузка и подготовка данных 
Пайплайном `FIBs_download.py` выполняется последовательность:

1. Скачивание FIB-снимков.
2. Складирование FIB-снимков в соответсвующие стаки.
3. Нормализация (приведение к значениям 0 - поры, 1 - YSZ, 2 - Ni).
4. Разделение стаков на патчи меньшего размера.
5. Сохранение каждого патча (массива `nd.array`) в `*.npy` файл.
6. Возврат списка сохраненных `*.npy` файлов.

`FIBs_download.py`
```
# Вызов функции
get_data(output='2D', output_dir='./data/', cube_size=456, overlap_fraction=0.5, balance=False, to_archive=False)
'''
Аргументы:
  output: string
    Требуемая размерность выходных данных
    Значения: 
      2D - двумерный выход .shape(y,x) 
      3D - трехмерный выход .shape(z,y,x)
  output_dir: string
    Директория для сохранения обработанных данных
  
  cube_size: integer
    размер кубического патча
  
  overlap_fraction: float (0-1)
    доля перекрытия между соседними патчами (0-1)

  balance: boolean
    Требуется ли балансировать выходные классы по количеству (True, False) 

  to_archive: boolean
    Требуется ли сохранить в архив выходные файлы 
'''

# Возвращаемые данные
return [2D_pristine_fine_01.npy,
        2D_pristine_fine_02.npy,
        ...
        2D_degraded_coarse_23.npy]
```
# 2. Обучение VAE c Conv2d на 2D снимках структуры
Для проверки способности выявления и разделения признаков деградации на датасете 2D снимков обучили VAE модель с Conv2d слоями.
Jupiter notebook обучения `03.02.2026_VAE.ipynb`

По итогам 20 эпох обучения `Val Loss` составил `0.2676` 

## История обучения

<img height="600" src="https://github.com/user-attachments/assets/e9b14274-d0cb-4ed1-87e0-7e65895e83a3" />

## Латентное пространство

<img height="600" src="https://github.com/user-attachments/assets/ac64cf32-f571-4f48-b363-02736048a6c1" />

Однотипные точки не кластеризуются, располагаются почти равномерно по всей площади, расстояния между классами не коррелирует с состояниями образцов:

- расстояние между pristine_fine        и pristine_medium     : 0.0815
- расстояние между pristine_fine        и pristine_coarse     : 0.1296
- расстояние между pristine_fine        и degraded_fine       : 0.0656
- расстояние между pristine_fine        и degraded_medium     : 0.1246
- расстояние между pristine_fine        и degraded_coarse     : 0.1615
- расстояние между pristine_medium      и pristine_coarse     : 0.0646
- расстояние между pristine_medium      и degraded_fine       : 0.0439
- расстояние между pristine_medium      и degraded_medium     : 0.0517
- расстояние между pristine_medium      и degraded_coarse     : 0.0989
- расстояние между pristine_coarse      и degraded_fine       : 0.0897
- расстояние между pristine_coarse      и degraded_medium     : 0.0524
- расстояние между pristine_coarse      и degraded_coarse     : 0.0624
- расстояние между degraded_fine        и degraded_medium     : 0.0797
- расстояние между degraded_fine        и degraded_coarse     : 0.1152
- расстояние между degraded_medium      и degraded_coarse     : 0.0693

## Восстановленные изображения

<img height="600" alt="Без названия (3)" src="https://github.com/user-attachments/assets/543df122-cafc-4969-b72b-7067aaaaad56" />

## Вывод: 
Для решения поставленной задачи выбранная модель и способ решения не подходит.

# 3. Построение графов по структуре

**Математическая формулировка**

Для любого дискретного представления структуры анода в виде трёхцветного изображения `I(x,y) ∈ {0,1,2}`, где:
```
0 = пора (газовая фаза)
1 = YSZ (ионный проводник)
2 = Ni (электронный проводник)
```
Существует однозначное отображение:

```
F: I → {G₀, G₁, G₂}
```
где:

`G₀` = граф пор (газовая транспортная сеть)

`G₁` = граф YSZ (ионная транспортная сеть)

`G₂` = граф Ni (электронная транспортная сеть)

И эти графы должны обладать следующими свойствами:

**Свойство 1: Полнота покрытия**

Три графа *вместе полностью* описывают всё пространство анода:
```
supp(G₀) ∪ supp(G₁) ∪ supp(G₂) = Ω  (вся область анода)
supp(G₀) ∩ supp(G₁) ∩ supp(G₂) = ∅  (непересекающиеся фазы)
```
где `supp(G)` — носитель графа (множество пикселей/вокселей, принадлежащих этой фазе).

**Свойство 2: Функциональная специализация**

Каждый граф описывает только один тип транспорта:

`G₀` → Диффузия газа (уравнение Фика-Кнудсена)

`G₁` → Миграция ионов O²⁻ (уравнение Нернста-Планка)

`G₂` → Дрейф электронов (закон Ома)

**Свойство 3: Топологическая двойственность (но не эквивалентность)**

Графы связаны отношением двойственности:
```
G₀ ≈ dual(G₁ ∪ G₂)
```
где `dual()` — оператор построения двойственного графа, а `∪` — объединение как материальных фаз.

Обобщая эти три свойства каждый образец (или его патч) должен описываться 3-мя графами `[G₀, G₁, G₂)`

## Данные графа:
1. Узлы
   
1.1 Наименование фазы (`pore, Ni, YSZ`)

1.2 Индекс фазы (`1, 2, 3`)

1.3. Координаты центроида (`x, y, z`)

1.4. Центроид участка

1.5. Объем участка

1.6. `bbox` участка

3. Связи между узлами (ребра)
   
2.1. Узел А и Узел Б

2.2 Вес связи `weight=1.0/(distance + 1e-6)`

2.3 Расстояние (distance)

## Визуализация графов (образец pristine_fine_16.npy):

Образец 3D структуры анода размером (456, 456, 456). Общее число вокселей: 94'818'816 ед.

Распределение фаз:

- `PORE` : 23,430,000 вокселей (24.71%)
- `YSZ`  : 40,286,308 вокселей (42.49%)
- `NI`   : 31,102,508 вокселей (32.80%)

<img height="800" alt="срезы" src="https://github.com/user-attachments/assets/84c3fcd6-a7d6-4678-ab1a-27d8706afdb6" />

Построенные графы:
- `PORE` : вершин: 66, рёбер: 25
- `YSZ`  : вершин: 34, рёбер: 6
- `NI`   : вершин: 142, рёбер: 40

Визуализация

<img height="400" alt="newplot" src="https://github.com/user-attachments/assets/5d017b09-bad8-4ef9-8848-8e26aeb75cc2" />

   
# 4. Обучение на графах Conditional (graph) VAE

Jupiter notebook обучения `conditional-graph-vae.ipynb`

**Архитектура модели**

ConditionalGraphVAE
Модель состоит из двух основных компонентов:

1. Условный энкодер (`ConditionalGraphEncoder`)
- три GNN-энкодера (по одному на каждую фазу)
- эмбеддинг условий (6 классов)
- межграфовое внимание (`Multihead Attention`)
- проекция в латентное пространство (`μ и logσ²`)

2. Условный декодер (`ConditionalGraphDecoder`)
- базовый декодер признаков узлов
- фазовые проекторы (3 отдельных MLP)
- проекция условий в латентное пространство
- предиктор рёбер на основе признаков узлов

**Параметры модели**
```
{
    'node_dim': 7,           # Признаки узла: объем, координаты, степень и др.
    'hidden_dim': 256,       # Размер скрытых слоёв
    'latent_dim': 32,        # Размерность латентного пространства
    'max_nodes': 50,         # Макс. узлов на граф (автонастройка от 30 до 50)
    'num_conditions': 6,     # Количество классов условий
    'batch_size': 2,         # Размер батча 
    'epochs': 50,            # Количество эпох обучения
    'lr': 1e-3,              # Learning rate
    'kl_weight': 0.0001,     # Вес KL дивергенции
    'beta_annealing': True   # Аннелинг веса KL
}
```

## История обучения: 
<img  height="800" alt="training_curves" src="https://github.com/user-attachments/assets/22319e10-6bd3-4cc8-924c-1cced2314e9d" />

## Латентное пространство

<img height="800" alt="latent_space_analysis" src="https://github.com/user-attachments/assets/814a89f1-28d5-4fd5-a975-99ac21d3ef88" />

Однотипные классы сгруппированы очень плотно, между разными образцами присутсвует явное расстояние. 
Визуальная интерпретация латентного пространства весьма хорошее.

## Вывод: 
Conditional VAE использующий на вход 3D графы очень хорошо справился с распределением латентного пространства, все соответствующие точки сгруппированы, образцы до и после деградации находятся на существенном удалении друг от друга. Целесообразно применение данной модели для дальнейшей проработки


## Возможные применения модели
1. Генеративный дизайн новых структур анодов
2. Предсказание свойств на основе структуры
3. Имитация деградации 


# Использование
Полный пайплайн обучения и загрузки обученной модели `Conditional Graph VAE` находится в файле `Conditional_Graph_VAE.py`

Обученная модель - `final_model.pth`

Необходимые зависимости для работы в файле `requirements.txt`
